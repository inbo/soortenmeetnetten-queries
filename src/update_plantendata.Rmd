---
title: "Update plantendata"
output: html_document
---

```{r}
library(tidyverse)
library(sf)
library(git2rdata)
library(units)
library(purrr)
library(readxl)
library(lubridate)

year_update <- 2022
```

## Aantallen ingevoerd in meetnetten.be

```{r}
aantallen_planten_visit_id <- read_vc("aantallen_planten", "../raw") %>%
  filter(puntlocatie == 1) %>%
  filter(validatie != -1) %>%
  filter(year(datum) == year_update) %>%
  group_by(meetnet, locatie, datum, visit_id, track) %>%
  summarise(n_puntlocaties = n()) %>%
  ungroup()
```



## Aantallen ingevoerd in waarnemingen.be

```{r}
data_path <- "G:/Mijn Drive/Soortenmeetnetten/Oplevering data/2022/Data niet in Meetnetten.be/Planten - Oplevering data Meetnetten 2022"

planten_update_orig <- read_excel(file.path(data_path, "exportplantenmeetnet2022_oplevering15december.xlsx"))

 planten_update <- planten_update_orig %>%
  mutate(Floroncode = ifelse(Floroncode == "0.0", "0" , Floroncode)) %>% 
  select(id, meetnet = naam_nl,  datum, invoerdatum,  x, y, aantal, floroncode = Floroncode, typewaarneming, waarnemer = wnr, status, locatie_np = Meetnet, opm = bijzonderheden, nieuwe_locatie = `nieuwe locatie`)%>%
  mutate(ingevoerd = !is.na(locatie_np),
         datum = as.Date(datum, format = "%Y-%m-%d"),
         jaar = as.numeric(format(as.Date(datum, format = "%Y-%m-%d"),"%Y")),
         uitvoerder = "vrijwilligers",
         brondatabank = "waarnemingen.be",
         id = as.character(id)) %>%
  mutate(x_coord = x, y_coord = y) %>%
  filter(!is.na(x)) %>%
  st_as_sf(coords = c("x", "y"), crs = 31370)

```



```{r}

locaties_planten_actief_sf <- st_read("../raw/meetnetten_locaties.gpkg", "locaties") %>%
  filter(soortgroep == "planten") %>%
  filter(is_active) %>%
  mutate(locatie = as.character(locatie),
         meetnet = as.character(meetnet)) %>%
    mutate(locatie = str_replace(locatie, "\u0091", "'"),
         locatie = str_replace(locatie, "\u0096", "-")) %>%
  select(meetnet, locatie) %>%
  st_transform(crs = 31370) 

data_extern_by_meetnet <- planten_update %>%
  group_by(meetnet) %>%
  nest()

closest_location_actief <- function(meetnet_select, observations) {
  
  locations_meetnet <- locaties_planten_actief_sf %>%
    filter(meetnet == meetnet_select )
  
  observations_result <- observations %>%
    st_join(locations_meetnet, join = st_nearest_feature) %>%
    group_by(id) %>%
    mutate(dist = min(drop_units(st_distance(geometry, locations_meetnet))),
           dist = round(dist, 0)) %>%
    ungroup() %>%
    dplyr::select(-meetnet) %>%
    st_drop_geometry()
  
  return(observations_result)
            
}

data_extern_by_meetnet <- data_extern_by_meetnet %>%
  mutate(data_locations_actief = map2(meetnet, data, closest_location_actief))

data_extern_locaties <- data_extern_by_meetnet %>%
  select(data_locations_actief) %>%
  unnest(data_locations_actief) %>%
  mutate(locatie = ifelse(dist > 500, NA, locatie),
         dist = ifelse(dist > 500, NA, dist),
         datum = as.Date(datum, format = "%Y-%m-%d"))

check <- data_extern_locaties %>%
  filter(!is.na(floroncode)) %>%
  mutate(naam_controle = locatie == locatie_np) %>%
  filter(!naam_controle)
check$locatie_np
check$locatie
n_distinct(check$locatie)

# locaties_planten_inactief_sf <- st_read("../raw/meetnetten_locaties.gpkg", "locaties") %>%
#   filter(soortgroep == "planten") %>%
#   filter(!is_active) %>%
#   mutate(locatie_inactief = as.character(locatie),
#          meetnet = as.character(meetnet)) %>%
#     mutate(locatie_inactief = str_replace(locatie_inactief, "\u0091", "'"),
#          locatie_inactief = str_replace(locatie_inactief, "\u0096", "-")) %>%
#   select(meetnet, locatie_inactief) %>%
#   st_transform(crs = 31370) 
# 
# closest_location_inactief <- function(meetnet_select, observations) {
#   
#   locations_meetnet <- locaties_planten_inactief_sf %>%
#     filter(meetnet == meetnet_select )
#   
#   observations_result <- observations %>%
#     st_join(locations_meetnet, join = st_nearest_feature) %>%
#     group_by(id) %>%
#     mutate(dist_inactief = min(drop_units(st_distance(geometry, locations_meetnet))),
#            dist_inactief = round(dist_inactief, 0)) %>%
#     ungroup() %>%
#     dplyr::select(-meetnet) %>%
#     st_drop_geometry()
#   
#   return(observations_result)
#             
# }
# 
# data_extern_locaties_inactief <- data_extern_by_meetnet %>%
#   mutate(data_locations_inactief =  map2(meetnet, data, closest_location_inactief)) %>% 
#   select(data_locations_inactief) %>%
#   unnest(data_locations_inactief)
# 
# data_extern_locaties_inactief <- data_extern_locaties_inactief %>%
#   select(meetnet, id, locatie_inactief, dist_inactief)
# 
# data_extern_locaties2 <- data_extern_locaties %>%
#   left_join(data_extern_locaties_inactief, by = c("id", "meetnet")) %>%
#     mutate(locatie_inactief = ifelse(dist_inactief > 500, NA, locatie_inactief),
#          dist_inactief = ifelse(dist_inactief > 500, NA, dist_inactief))
```

```{r}

bezoeken_planten <- read_vc("bezoeken", "../raw") %>%
  filter(soortgroep == "planten") %>%
  filter(jaar == 2022) %>%
    mutate(locatie = ifelse(locatie == "Goor <U+0096> Asbroek (d5-16-34)", "Goor - Asbroek (d5-16-34)", locatie),
           locatie = ifelse(locatie == "<U+0091>s Hertogenheide (d5-45-24)", "'s Hertogenheide (d5-45-24)", locatie),
           locatie = ifelse(locatie == "Goorke <U+0096> Rode Del (b6-43-31)", "Goorke - Rode Del (b6-43-31)", locatie),
           hoofdteller = str_to_lower(hoofdteller),
           aantallen_in_meetnetten = visit_id %in% aantallen_planten_visit_id$visit_id) %>%
  left_join(locaties_planten_actief_sf, by = c("meetnet", "locatie")) %>%
  select(meetnet, locatie, protocol, datum, visit_id, hoofdteller, aantallen_in_meetnetten)

data_waarnemingen_migratie <- data_extern_locaties %>%
  filter(!is.na(floroncode)) %>%
  left_join(bezoeken_planten, by = c("meetnet", "locatie", "datum")) %>%
  rename(afstand_tot_locatie = "dist") %>%
  mutate(bron = "waarenmingen.be") 

check_naam_teller <- data_waarnemingen_migratie %>%
  filter(!is.na(visit_id)) %>%
  group_by(meetnet, locatie, visit_id, datum) %>%
  summarise(n_waarnemer_mn = n_distinct(hoofdteller),
            waarnemers_meetnetten = str_c(unique(str_to_lower(hoofdteller)), collapse = ";"),
            waarnemers_waarnemingen = str_c(unique(str_to_lower(waarnemer)), collapse = ";"),
         n_waarnemer_wnm = n_distinct(waarnemer)) %>%
  ungroup() %>%
  filter(waarnemers_meetnetten != waarnemers_waarnemingen)

data_waarnemingen_migratie <- data_extern_locaties %>%
  mutate(hoofdteller = ifelse(str_to_lower(waarnemer) == "koen", "koen verhoeyen",
                            ifelse(str_to_lower(waarnemer) == "rijmenans gilbert", "gilbert rijmenans",
                                   ifelse(str_to_lower(waarnemer) == "thomas", "thomas gyselinck",
                                          ifelse(str_to_lower(waarnemer) == "christine verscheure en eckhart kuijken", "christine verscheure",
                                                 ifelse(locatie == "Scheldeoever7 (Schellebelle-Uitbergen)", "robbert schepers",
                                                        ifelse(str_to_lower(waarnemer) == "nsg beneden-dijle", "marie-louise selleslach",
                                                        str_to_lower(waarnemer)))))))
                                   ) %>%
  filter(!is.na(floroncode)) %>%
  left_join(bezoeken_planten, by = c("meetnet", "locatie", "datum", "hoofdteller")) %>%
  filter(!aantallen_in_meetnetten | is.na(aantallen_in_meetnetten)) %>%
  rename(afstand_tot_locatie = "dist") %>%
  mutate(bron = "waarenmingen.be")  %>%
  select(bron, meetnet, protocol, locatie, afstand_tot_locatie, jaar, datum, hoofdteller, waarnemer_wnm.be = waarnemer, id_wnm = id, code = floroncode,  aantal, x =x_coord, y = y_coord, visit_id, opm)

data_waarnemingen_extra <- data_extern_locaties %>%
  filter(is.na(floroncode)) %>%
  rename(afstand_tot_locatie = "dist") %>%
  mutate(bron = "waarenmingen.be",
         nieuwe_locatie = ifelse(nieuwe_locatie == "1.0", "1", nieuwe_locatie)) %>%
  select(bron, meetnet, locatie, afstand_tot_locatie, nieuwe_locatie, jaar, datum, waarnemer, id_wnm = id,  code = floroncode,  aantal, x = x_coord, y = y_coord, opm)

data_waarnemingen_migratie %>%
  filter(!is.na(visit_id)) %>%
  write_csv2(file = str_c("../output/controle_plantendata/plantenmeetnetten_migratie_", year_update, ".csv", na = ""))

write_csv2(data_waarnemingen_extra, 
           file = str_c("../output/controle_plantendata/plantenmeetnetten_extra_", year_update, ".csv", na = ""))
```

## Waarnemingen zonder bezoeken

```{r}

controle_bezoeken <- data_waarnemingen_migratie %>%
  filter(is.na(visit_id)) %>%
  select(id_wnm, meetnet, locatie, datum,  code, x, y, waarnemer_wnm.be, opm)

write_csv2(controle_bezoeken, str_c("../output/controle_plantendata/wnm_planten_zonderbezoeken_", year_update, ".csv"))
```

## Bezoeken zonder waarnemingen

```{r}

bezoeken_planten_zonderdata <- read_vc("bezoeken", "../raw") %>%
    filter(validatie != -1) %>%
    filter(soortgroep == "planten") %>%
 #     filter(voor_analyse) %>%
  filter(jaar == year_update) %>%
  filter(! visit_id %in% data_waarnemingen_migratie$visit_id) %>%
  filter(! visit_id %in% aantallen_planten_visit_id$visit_id) %>%
  select(meetnet, locatie, datum, visit_id, bezoek_status, hoofdteller, notes, voor_analyse, jaardoel) %>%
  filter(jaardoel & voor_analyse)

write_csv2(bezoeken_planten_zonderdata, str_c("../output/controle_plantendata/bezoeken_planten_zonderwnm_", year_update, ".csv"))
```

## Alle nieuwe data voor meetnetevaluatie

```{r}
aantallen_planten_meetnetten <- read_sf(dsn = "../raw/planten_puntlocaties.gpkg", "planten_puntlocaties") %>%
  mutate(jaar = as.numeric(format(datum, "%Y"))) %>%
  st_transform(crs = 31370) %>%
  filter(jaar == year_update) %>%
  filter(validatie_bezoek != -1) %>%
  mutate(bron = "meetnetten.be",
         afstand_tot_locatie = 0) %>%
  select(-soort_w, -beschrijving_floroncode,  -sample_id, -validatie_bezoek) %>%
  rename(hoofdteller = waarnemer)

aantallen_meetnetten <- aantallen_planten_meetnetten %>%
  st_drop_geometry() %>%
  mutate(x = st_coordinates(aantallen_planten_meetnetten)[, 1],
         y = st_coordinates(aantallen_planten_meetnetten)[, 2])

locaties_track <- aantallen_meetnetten %>%
  distinct(meetnet, locatie, visit_id, datum, track)

aantallen_planten <- bind_rows(data_waarnemingen_migratie,
                               aantallen_meetnetten) %>%
  arrange(meetnet, locatie, bron) %>%
  select(-schaal)

write_csv2(aantallen_planten, str_c("../processed/data_planten_", year_update,".csv",  na = ""))

write_csv2(locaties_track, str_c("../output/controle_plantendata/controle_tracks_", year_update, ".csv"), na = "")
```



